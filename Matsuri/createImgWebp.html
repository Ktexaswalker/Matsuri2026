<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CREATE_PROFILE</title>
    <meta name="author" content="Hector Martinez">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bootstrap.css">
	<script src="js/bootstrap.bundle.js"></script>
    <script src="./js/volunteer.js"></script>
    <style>
        .avatar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 40px;
            max-width: 50%;
        }
    </style>
</head>
<body>
    <!-- <img class="optimizable" data-src="webp/voluntarios/Hector.png" src="webp/voluntarios/Hector.png" alt="" loading="lazy"> -->
    <section class="container-fluid">
        <div class="row justify-content-around" id="bucle">
            
        </div>
    </section>
    <script>
        const MAX_FAILS = 3;
        const LOAD_DELAY = 50;
        const MAX_VIEWPORT = 70;
        // --------- MODO LOCAL ---------
        if (location.protocol === "file:") {
            document.body.innerHTML = `
                <div style="font-family:sans-serif;padding:2rem;background:#111;color:#fff;">
                <h2>⚠️ Esta web requiere servidor local</h2>
                <p>
                    Has abierto el archivo con <code>file://</code><br>
                    Esta aplicación necesita ejecutarse con un servidor HTTP.
                </p>
                <pre>
                    python -m http.server
                    npx serve
                    npx live-server
                </pre>
                <p>
                    <a style="color:white" href="http://127.0.0.1:5500/Matsuri/createImgWebp.html">http://localhost:5500</a><br>
                    <a style="color:white" href="http://127.0.0.1:8000/Matsuri/createImgWebp.html">http://localhost:8000</a>
                </p>
                <label>Nombre:</label>
                <input type="text" id="nombre"><br><br>
                <input type="file" id="file"><br><br>
                <label>URL de imagen:</label>
                <input type="url" id="url" placeholder="https://..."><br><br>
                <div style="max-width:${MAX_VIEWPORT}vw;max-height:${MAX_VIEWPORT}vh;overflow:auto;display:flex;justify-content:center;align-items:center;">
                    <img id="preview" style="display:block;max-width:100%">
                </div>
                <br>
                    <button id="guardar">Guardar imagen en webp</button>
                </div>
            `;
            const fileInput = document.getElementById("file");
            const urlInput = document.getElementById("url");
            const preview = document.getElementById("preview");
            const guardar = document.getElementById("guardar");
            const nombreInput = document.getElementById("nombre");
            let fuenteActual = null; // 'file' | 'url'
            fileInput.addEventListener("change", e => {
                const file = e.target.files[0];
                if (!file) return;
                fuenteActual = 'file';
                preview.src = URL.createObjectURL(file);
            });
            urlInput.addEventListener("change", () => {
                const url = urlInput.value.trim();
                if (!url) return;
                try {
                    new URL(url);
                    fuenteActual = 'url';
                    preview.crossOrigin = "anonymous";
                    preview.src = url;
                } catch {
                    alert("URL no válida");
                }
            });
            guardar.addEventListener("click", () => {
                if (fuenteActual === "url") {
                    try {
                        canvas.toDataURL("image/webp");
                    } catch {
                        alert("La URL no permite conversión directa (CORS). Usa descarga + subir archivo.");
                        return;
                    }
                }
                if (!preview.src) return alert("No hay imagen cargada");
                const canvas = document.createElement("canvas");
                const img = new Image();
                img.src = preview.src;
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    const webp = canvas.toDataURL("image/webp", 0.9);
                    const link = document.createElement("a");
                    const nombre = nombreInput.value || "imagen";
                    link.href = webp;
                    link.download = `${nombre}.webp`;
                    link.click();
                };
            });
        } else {
            // -------- MODO SERVIDOR --------
            function decode(input) {
                return atob(input);
            }
            function leerInfoVoluntarios(i) {
                let result = [];
                Object.keys(voluntarios).forEach(key => {
                    const p = voluntarios[key];
                    const id = decode(p.id);
                    const name = decode(p.name);
                    const rol = decode(p.rol);
                    const descrip = decode(p.descripcion);
                    const links = Object.values(p.links).map(l => decode(l));
                    const trabj = decode(p.trabajos);
                    const tags = Object.values(p.tags).map(t => decode(t));
                    result.push({id, name, rol, descrip, links, trabj, tags});
                });
                return result;
            }
            const bucle = document.getElementById("bucle");
            let count = 1;
            let fails = 0;
            function loadAllImages() {
                const img = document.createElement("img");
                img.src = `./webp/voluntarios/${count}.webp`;
                img.className = "avatar";
                img.onload = () => {
                    bucle.appendChild(img);
                    count++;
                    fails = 0;
                    loadAllImages();
                };
                img.onerror = () => {
                    fails++;
                    if (fails < MAX_FAILS) {
                        count++;
                        setTimeout(loadAllImages, LOAD_DELAY);
                    } else {
                        console.log(`✔ Fin de carga. Última imagen válida: ${count - fails}`);
                    }
                };
            }
            // iniciar carga
            // loadAllImages();
            function obtenerDominio(url) {
                try {
                    if (!/^https?:\/\//i.test(url)) {
                        url = "https://" + url;
                    }
                    return new URL(url).hostname.replace(/^www\./, "").split('.')[0];;
                } catch {
                    return url;
                }
            }
            //Pasar todo a contenido dinamico
            const listaV = leerInfoVoluntarios();
            listaV.forEach((valor, i) => {
                const container1 = document.createElement("div");
                container1.classList.add("col", "col-sm-12", "col-lg-6", "col-xl-6", "col-xxl-6");

                const container2 = document.createElement("div");
                container2.classList.add("container", "pt-5");

                const container3 = document.createElement("div");
                container3.classList.add("bg-container-animation", "container-fluid", "bg-dblue", "border", "rounded-4", "p-sm-4", "p-3");

                const article1 = document.createElement("article");
                article1.classList.add("row", "d-flex", "align-items-center", "justify-content-center");

                const container4 = document.createElement("div");
                container4.classList.add("bg-transparent",
                "offset-0", "col-12", "offset-sm-0", "col-sm-12", "order-sm-1", "offset-md-0", 
                "col-md-6", "order-md-2", "offset-lg-0", "col-lg-6", "order-lg-2", 
                "offset-xl-0", "col-xl-6", "order-xl-2", "offset-xxl-0", "col-xxl-6", 
                "order-xxl-2", "bg-dblue", "rounded-4", "ps-3", "w-lg-50", "w-xl-50", "w-xxl-50");
                // NOMBRE
                const name = document.createElement("h3");
                name.classList.add("fw-bold", "d-flex", "justify-content-between");
                name.textContent = valor.name;
                article1.appendChild(name);
                // ROL
                const rol = document.createElement("div");
                rol.classList.add("btn", "bg-dgrey", "pe-none");
                rol.textContent = valor.rol;
                name.appendChild(rol);
                // DESCRIPCION
                const descrip = document.createElement("p");
                descrip.classList.add("pt-3");
                descrip.textContent = valor.descrip;
                container4.appendChild(descrip);
                // LINKS
                valor.links.forEach(l => {
                    // const ul = document.createElement("ul");
                    // ul.classList.add("list-unstyled", "my-1");
                    // const li = document.createElement("li");
                    // li.classList.add("m-0", "p-0")
                    const button = document.createElement("button");
                    button.classList.add("mx-1", "p-1", "bg-cgold", "rounded");
                    const a = document.createElement("a");
                    a.classList.add("p-0", "text-decoration-none", "text-wwhite");
                    a.href = l;
                    a.textContent = `${obtenerDominio(l)}`;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    button.appendChild(a);
                    container4.appendChild(button);
                });
                // TRABAJOS
                const trabajos = document.createElement("p");
                trabajos.classList.add("pt-3");
                trabajos.textContent = valor.trabj;
                container4.appendChild(trabajos);
                article1.appendChild(container4);
                // TAGS
                valor.tags.forEach(t => {
                    const tag = document.createElement("div");
                    tag.classList.add("btn", "bg-3blue", "me-1", "pe-none", "px-1", "py-0")
                    tag.textContent = t;
                    container4.appendChild(tag);
                })



                const containerMovil1 = document.createElement("div");
                containerMovil1.classList.add("col-12", "order-2", "offset-0", "d-block", "d-sm-none", "w-lg-50", "w-xl-50", "w-xxl-50");

                const containerMovil2 = document.createElement("div");
                containerMovil2.classList.add("d-flex", "align-items-start", "col-12", "order-2", 
                "col-md-6", "order-md-2", "col-xl-6", "offset-xl-0", "bg-dblue", "w-lg-50", "w-xl-50", "w-xxl-50");
                // IMAGEN
                const img = document.createElement("img");
                img.classList.add("rounded-3", "img-fluid", "card-img-top");
                img.src = `webp/voluntarios/${valor.id}.webp`;
                img.alt = valor.name;

                containerMovil2.appendChild(img);
                containerMovil1.appendChild(containerMovil2);
                const containerTablet1 = document.createElement("div");
                containerTablet1.classList.add("d-none", "col-sm-12", "offset-sm-0", "order-sm-2", "d-sm-block", 
                "col-md-6", "offset-md-0", "order-md-1", "col-lg-6", "offset-lg-0", "d-md-block", "w-lg-50", "w-xl-50", "w-xxl-50", "mt-3");
                const containerTablet2 = document.createElement("div");
                containerTablet2.classList.add("d-flex", "align-items-start", "col-12", "order-2", "col-md-12", "order-md-2", "col-xl-12", 
                "offset-xl-0", "bg-dblue", "w-lg-50", "w-xl-50", "w-xxl-50");
                const img1 = document.createElement("img");
                img1.classList.add("rounded-3", "img-fluid", "card-img-top");
                img1.src = `webp/voluntarios/${valor.id}.webp`;
                img1.alt = valor.name;
                containerTablet2.appendChild(img1);
                containerTablet1.appendChild(containerTablet2);
                article1.appendChild(containerTablet1);
                article1.appendChild(containerMovil1)
                container3.appendChild(article1);
                container2.appendChild(container3);
                container1.appendChild(container2);
                document.getElementById("bucle").appendChild(container1);
            });
        }
    </script>
</body>
</html>